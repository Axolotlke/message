<?php
// $Id$
/**
 * @file
 * Primarily Drupal hooks and global API functions to manipulate activity.
 *
 * This is the main module file for Activity.
 */

/**
 * Implementation of hook_ctools_plugin_api().
 */
function ron_ctools_plugin_api($module, $api) {
  if ($module == 'ron' && $api == 'plugins') {
    return array('version' => 3);
  }
}

/**
 * Implementation of hook_ron_plugins().
 *
 * This is a ctools plugins hook.
 */
function ron_ron_plugins() {
  module_load_include('inc', 'ron', '/includes/ron.plugins');
  return _ron_ron_plugins();
}

/**
 * Implementation of hook_views_api().
 */
function ron_views_api() {
  return array(
    'api' => 2.0,
    'path' => drupal_get_path('module', 'ron') . '/includes',
  );
}

/**
 * Get messages by their ID.
 *
 * @param $message_id
 *   The message ID.
 * @return
 *   Array  keyed by the message realm and the realm Id as the value.
 */
function ron_get_message_realm($message_id) {
  static $messages = array();

  if (!isset($messages[$message_id])) {
    $result = db_query("SELECT * FROM {ron_messages_realm} WHERE iid = %d", $message_id);

    while ($row = db_fetch_object($result)) {
      $messages[$message_id][$row->realm][$row->realm_id] = $row->realm_id;
    }
  }
  return $messages[$message_id] ;
}

function ron_get_message($message_id) {
  return db_fetch_object(db_query("SELECT * FROM {ron_messages} WHERE mid = %d", $message_id));
}

function ron_get_message_instance($instance_id) {
  $return = db_fetch_object(db_query("SELECT * FROM {ron_messages_instance} WHERE iid = %d", $instance_id));
  // Unserialize the arguments.
  if (!empty($return->arguments)) {
    $return->arguments = unserialize($return->arguments);
  }
  return $return;
}

function ron_show_message($instance_id, $account = NULL) {
  $output = '';
  $access = FALSE;
  if (empty($account)) {
    global $user;
    $account = $user;
  }

  $message_instance = ron_get_message_instance($instance_id);

  if ($messages = ron_get_message_realm($message_instance->mid)) {
    $plugins = ctools_get_plugins('ron', 'plugins');
    foreach ($plugins as $plugin) {
      if (!empty($plugin['ron_realm']) && $class = ctools_plugin_get_class($plugin, 'handler')) {
        $info = array(
          'plugin' => $plugin,
          'message_id' => $message_instance->mid,
          'realm' => $plugin['ron_realm'],
          'account' => $account,
        );
        $handler = new $class($plugin, $info);
        if ($handler->access()) {
          $access = TRUE;
          break;
        }
      }
    }

    if ($access) {
      // Get the message template
      $output = ron_t($message_instance);
    }
  }

  return $output;
}

/**
 * Replace he arguments with their placeholders.
 *
 * @param $message
 *   The message instance object.
 *
 * @see t().
 */
function ron_t($message_instance) {
  $message = ron_get_message($message_instance->mid);

  if (module_exists(i18nstrings)) {
    $string = i18nstrings("ron:ron_message:$message->mid:message", $message->message);
  }
  else {
    $string = $message->message;
  }

  if (empty($message_instance->arguments)) {
    return $string;
  }
  else {
    // Transform arguments before inserting them.
    foreach ($message_instance->arguments as $key => $value) {
      switch ($key[0]) {
        case '@':
          // Escaped only.
          $args[$key] = check_plain($value);
          break;

        case '%':
        default:
          // Escaped and placeholder.
          $args[$key] = theme('placeholder', $value);
          break;

        case '!':
          // Pass-through.
      }
    }
    return strtr($string, $args);
  }
}